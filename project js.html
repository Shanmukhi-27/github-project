// ===============================
// ğŸ“š Node.js Bookstore Project
// Tasks 1â€“14 in one file
// ===============================

const express = require("express");
const bodyParser = require("body-parser");
const axios = require("axios");

const app = express();
app.use(bodyParser.json());

// ===============================
// ğŸ“– Book Database
// ===============================
let books = {
  "9781234567890": {
    title: "Node.js for Beginners",
    author: "John Doe",
    reviews: {}
  },
  "9780987654321": {
    title: "Learning Express",
    author: "Jane Smith",
    reviews: {}
  }
};

// ğŸ§â€â™‚ï¸ Registered Users
let users = [];

// ===============================
// ğŸ“Œ API Endpoints
// ===============================

// âœ… Task 1: Get all books
app.get("/", (req, res) => {
  res.json(books);
});

// âœ… Task 2: Get books based on ISBN
app.get("/isbn/:isbn", (req, res) => {
  const isbn = req.params.isbn;
  const book = books[isbn];
  if (book) res.json(book);
  else res.status(404).json({ message: "Book not found" });
});

// âœ… Task 3: Get all books by Author
app.get("/author/:author", (req, res) => {
  const author = req.params.author;
  const result = Object.values(books).filter(b => b.author === author);
  if (result.length > 0) res.json(result);
  else res.status(404).json({ message: "No books found for this author" });
});

// âœ… Task 4: Get all books by Title
app.get("/title/:title", (req, res) => {
  const title = req.params.title;
  const result = Object.values(books).filter(b => b.title === title);
  if (result.length > 0) res.json(result);
  else res.status(404).json({ message: "No books found with this title" });
});

// âœ… Task 5: Get Book Review
app.get("/review/:isbn", (req, res) => {
  const isbn = req.params.isbn;
  const book = books[isbn];
  if (book) res.json(book.reviews);
  else res.status(404).json({ message: "Book not found" });
});

// âœ… Task 6: Register New User
app.post("/register", (req, res) => {
  const { username, password } = req.body;
  if (!username || !password)
    return res.status(400).json({ message: "Username and password required" });

  const exists = users.find(u => u.username === username);
  if (exists)
    return res.status(400).json({ message: "User already exists" });

  users.push({ username, password });
  res.json({ message: "User registered successfully" });
});

// âœ… Task 7: Login as Registered User
app.post("/login", (req, res) => {
  const { username, password } = req.body;
  const user = users.find(u => u.username === username && u.password === password);
  if (user) res.json({ message: "Login successful" });
  else res.status(401).json({ message: "Invalid credentials" });
});

// âœ… Task 8: Add/Modify a Book Review
app.put("/review/:isbn", (req, res) => {
  const { username, review } = req.body;
  const isbn = req.params.isbn;
  const book = books[isbn];
  if (!book) return res.status(404).json({ message: "Book not found" });

  book.reviews[username] = review;
  res.json({ message: "Review added/modified successfully", book });
});

// âœ… Task 9: Delete Book Review
app.delete("/review/:isbn", (req, res) => {
  const { username } = req.body;
  const isbn = req.params.isbn;
  const book = books[isbn];
  if (!book) return res.status(404).json({ message: "Book not found" });

  if (book.reviews[username]) {
    delete book.reviews[username];
    res.json({ message: "Review deleted successfully", book });
  } else {
    res.status(404).json({ message: "No review found for this user" });
  }
});

// ===============================
// ğŸŒ Start Server
// ===============================
const PORT = 5000;
app.listen(PORT, async () => {
  console.log(`âœ… Server running on http://localhost:${PORT}`);

  // ===============================
  // ğŸ“¦ Task 10â€“13: Axios Methods
  // ===============================

  // âœ… Task 10: Get all books using async callback
  async function getAllBooks(callback) {
    try {
      const response = await axios.get(`http://localhost:${PORT}/`);
      callback(null, response.data);
    } catch (error) {
      callback(error, null);
    }
  }
  getAllBooks((err, data) => {
    if (err) console.log("âŒ Error:", err.message);
    else console.log("ğŸ“š All Books:", data);
  });

  // âœ… Task 11: Search by ISBN using Promises
  function getBookByISBN(isbn) {
    return axios
      .get(`http://localhost:${PORT}/isbn/${isbn}`)
      .then(response => console.log("ğŸ”– Book by ISBN:", response.data))
      .catch(error => console.log("âŒ Error:", error.message));
  }
  await getBookByISBN("9781234567890");

  // âœ… Task 12: Search by Author
  async function getBooksByAuthor(author) {
    try {
      const response = await axios.get(`http://localhost:${PORT}/author/${author}`);
      console.log("âœï¸ Books by Author:", response.data);
    } catch (error) {
      console.log("âŒ Error fetching by author:", error.message);
    }
  }
  await getBooksByAuthor("John Doe");

  // âœ… Task 13: Search by Title
  async function getBooksByTitle(title) {
    try {
      const response = await axios.get(`http://localhost:${PORT}/title/${title}`);
      console.log("ğŸ“˜ Books by Title:", response.data);
    } catch (error) {
      console.log("âŒ Error fetching by title:", error.message);
    }
  }
  await getBooksByTitle("Node.js for Beginners");

  // âœ… Task 14: Ready for GitHub Submission ğŸ¯
  console.log("ğŸš€ All tasks (1â€“14) completed successfully!");
});
